<!--ç»“æœé¡µ-->
<view class="container">
  
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <!-- <view class="header">
    <view class="nav-icon" bindtap="onBackHome">
      <text class="icon-arrow">â†</text>
    </view>
    <text class="header-title">è§£æç»“æœ</text>
    <view class="nav-icon" bindtap="onClose">
      <text class="icon-close">Ã—</text>
    </view>
  </view> -->

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-state" wx:if="{{loading}}">
    <view class="loading-content">
      <view class="loading-spinner"></view>
      <text class="loading-text">{{i18n.result.loading}}</text>
    </view>
  </view>

  <!-- ç»“æœå†…å®¹ -->
  <view class="result-content" wx:elif="{{result}}">
    <!-- æ¢¦å¢ƒå†…å®¹ -->
    <view class="dream-content-section">
      <view class="section-title">{{i18n.result.dreamContent}}</view>
      <view class="cloud-card dream-content-card">
        <text class="dream-text" user-select="{{true}}">{{result.dreamDescription}}</text>
      </view>
    </view>

    <!-- å…³é”®è¯ -->
    <view class="keywords-section" wx:if="{{result.keywords && result.keywords.length > 0}}">
      <view class="section-title">{{i18n.result.keywords}}</view>
      <view class="keywords-container">
        <view class="keyword-tag" wx:for="{{result.keywords}}" wx:key="index">
          {{item}}
        </view>
      </view>
    </view>

    <!-- æ¢¦å¢ƒè§£æ -->
    <view class="analysis-section" wx:if="{{result.interpretation}}">
      <view class="section-title">{{i18n.result.dreamAnalysis}}</view>
      <view class="cloud-card analysis-card">
        <view class="analysis-content">
          <view 
            class="analysis-paragraph" 
            wx:for="{{result.interpretationParagraphs}}" 
            wx:key="index"
            user-select="{{true}}"
          >
            {{item}}
          </view>
        </view>
        <view class="ai-disclaimer">
          <text class="disclaimer-text">{{i18n.result.aiDisclaimer}}</text>
        </view>
      </view>
    </view>

    <!-- ç–å¯¼æ€§é—®é¢˜ -->
    <view class="guiding-questions-section" wx:if="{{result.guidingQuestion1 || result.guidingQuestion2}}">
      <view class="section-title">{{i18n.result.guidingQuestions}}</view>
      <view class="cloud-card guiding-questions-card">
        <view class="questions-intro">
          <text class="intro-text">{{i18n.result.questionsIntro}}</text>
        </view>
        
        <!-- å¼•å¯¼é—®é¢˜æŠ˜å é¢æ¿ -->
        <van-collapse value="{{activeNames}}" bind:change="onCollapseChange" wx:if="{{result.guidingQuestion1 || result.guidingQuestion2}}">
          <!-- é—®é¢˜ä¸€ -->
          <van-collapse-item 
            name="question1" 
            title="{{i18n.result.question1}}" 
            wx:if="{{result.guidingQuestion1}}"
            custom-class="question-collapse-item"
          >
            <view class="question-content">
              <text class="question-text" user-select="{{true}}">{{result.guidingQuestion1}}</text>
            </view>
            <view class="answer-container" wx:if="{{!result.guidingQuestion1Answer}}">
              <textarea 
                class="answer-textarea"
                placeholder="{{i18n.result.answerPlaceholder}}"
                value="{{answer1}}"
                bindinput="onAnswer1Input"
                maxlength="500"
                show-confirm-bar="{{false}}"
              ></textarea>
              <view class="char-count">{{answer1.length}}/500</view>
            </view>
          </van-collapse-item>

          <!-- é—®é¢˜äºŒ -->
          <van-collapse-item 
            name="question2" 
            title="{{i18n.result.question2}}" 
            wx:if="{{result.guidingQuestion2}}"
            custom-class="question-collapse-item"
          >
            <view class="question-content">
              <text class="question-text" user-select="{{true}}">{{result.guidingQuestion2}}</text>
            </view>
            <view class="answer-container" wx:if="{{!result.guidingQuestion2Answer}}">
              <textarea 
                class="answer-textarea"
                placeholder="{{i18n.result.answerPlaceholder}}"
                value="{{answer2}}"
                bindinput="onAnswer2Input"
                maxlength="500"
                show-confirm-bar="{{false}}"
              ></textarea>
              <view class="char-count">{{answer2.length}}/500</view>
            </view>
          </van-collapse-item>
        </van-collapse>

        <!-- ä¿å­˜å›ç­”æŒ‰é’® -->
        <view class="save-answers-container" wx:if="{{(!result.guidingQuestion1Answer && answer1) || (!result.guidingQuestion2Answer && answer2)}}">
          <button 
            class="save-answers-btn {{savingAnswers ? 'saving' : ''}}"
            bindtap="onSaveAnswers"
            disabled="{{savingAnswers}}"
          >
            <text wx:if="{{!savingAnswers}}">{{i18n.result.saveAnswers}}</text>
            <text wx:else>{{i18n.result.saving}}</text>
          </button>
        </view>
      </view>
    </view>

    <!-- AIæ¢¦å¢ƒå›¾åƒï¼ˆä»…æ–‡ç”Ÿå›¾æ¨¡å¼ï¼‰ -->
    <view class="image-section" wx:if="{{!isVideoType && result.imageUrl}}">
      <view class="section-title">{{i18n.result.aiImage}}</view>
      <view class="image-container">
        <image class="dream-image" src="{{result.imageUrl}}" mode="aspectFill" bindtap="onPreviewImage" />
      </view>
      <view class="image-description" wx:if="{{result.imagePrompt}}">
        <text class="description-text" user-select="{{true}}">{{result.imagePrompt}}</text>
      </view>
    </view>

    <!-- AIæ¢¦å¢ƒè§†é¢‘ï¼ˆä»…æ–‡ç”Ÿè§†é¢‘æ¨¡å¼ï¼‰ -->
    <view class="video-section" wx:if="{{isVideoType}}">
      <view class="section-title">{{i18n.result.aiVideo}}</view>
      
      <!-- è§†é¢‘ç”Ÿæˆä¸­çŠ¶æ€ -->
      <view class="video-status-container" wx:if="{{videoStatus === 1}}">
        <view class="cloud-card video-status-card">
          <view class="status-icon">â³</view>
          <view class="status-text">{{i18n.result.videoGenerating}}</view>
          <view class="status-tip">{{i18n.result.videoGeneratingTip}}</view>
        </view>
      </view>

      <!-- è§†é¢‘ç”Ÿæˆå¤±è´¥çŠ¶æ€ -->
      <view class="video-status-container" wx:if="{{videoStatus === 3}}">
        <view class="cloud-card video-status-card">
          <view class="status-icon">âŒ</view>
          <view class="status-text">{{i18n.result.videoFailed}}</view>
          <view class="status-tip">{{i18n.result.videoFailedTip}}</view>
        </view>
      </view>

      <!-- è§†é¢‘æ’­æ”¾å™¨ -->
      <view class="video-container" wx:if="{{videoStatus === 2 && videoUrl}}">
        <video 
          class="dream-video"
          src="{{videoUrl}}"
          controls
          show-center-play-btn
          enable-play-gesture
          object-fit="contain"
        ></video>
        
        <!-- è§†é¢‘æ“ä½œæŒ‰é’® -->
        <view class="video-actions">
          <button class="video-action-btn download-btn" bindtap="onDownloadVideo">
            <text class="action-icon">â¬‡ï¸</text>
            <text class="action-text">{{i18n.result.downloadVideo}}</text>
          </button>
        </view>
        
        <!-- è§†é¢‘æç¤ºè¯æè¿° -->
        <view class="video-description" wx:if="{{result.videoPrompt}}">
          <text class="description-text" user-select="{{true}}">{{result.videoPrompt}}</text>
        </view>
      </view>
    </view>

    <!-- å‘å¸ƒ/æµ·æŠ¥ æŒ‰é’®æ¨ªæ’ -->
    <view class="actions-section" wx:if="{{result}}">
      <button class="action-btn publish-button small" wx:if="{{result.analysisId && isLoggedIn}}" bindtap="onPublishToCommunity">
        <text class="publish-icon">ğŸ“¤</text>
        <text class="publish-text">{{i18n.result.publish}}</text>
      </button>
      <button class="action-btn poster-button small" bindtap="onGeneratePoster">
        <text class="poster-icon">ğŸ¨</text>
        <text class="poster-text">{{i18n.result.generatePoster}}</text>
      </button>
    </view>

    <!-- åé¦ˆåŒºåŸŸ -->
    <view class="feedback-section" wx:if="{{result}}">
      <view class="section-title">{{i18n.result.rateUs}}</view>
      <view class="cloud-card feedback-card">
        <!-- åé¦ˆè¡¨å• -->
        <view wx:if="{{!feedbackSubmitted}}">
          <!-- æ˜Ÿçº§è¯„åˆ† -->
          <view class="rating-container">
            <text class="rating-label">{{i18n.result.ratingLabel}}</text>
            <view class="stars-container">
              <view 
                class="star {{index < feedbackRating ? 'active' : ''}}" 
                wx:for="{{[1,2,3,4,5]}}" 
                wx:key="index"
                data-rating="{{index + 1}}"
                bindtap="onStarTap"
              >
                {{index < feedbackRating ? 'â­' : 'â˜†'}}
              </view>
            </view>
            <text class="rating-text">{{feedbackRating > 0 ? feedbackRating + i18n.result.score : i18n.result.selectRating}}</text>
          </view>
          
          <!-- åé¦ˆè¾“å…¥æ¡† -->
          <view class="feedback-input-container">
            <text class="feedback-label">{{i18n.result.feedbackLabel}}</text>
            <textarea 
              class="feedback-textarea"
              placeholder="{{i18n.result.feedbackPlaceholder}}"
              value="{{feedbackContent}}"
              bindinput="onFeedbackInput"
              maxlength="1000"
              show-confirm-bar="{{false}}"
            ></textarea>
            <view class="char-count">{{feedbackContent.length}}/1000</view>
          </view>
          
          <!-- æäº¤æŒ‰é’® -->
          <button 
            class="feedback-submit-btn {{submittingFeedback ? 'submitting' : ''}}"
            bindtap="onSubmitFeedback"
            disabled="{{submittingFeedback}}"
          >
            <text wx:if="{{!submittingFeedback}}">{{i18n.result.submitFeedback}}</text>
            <text wx:else>{{i18n.result.submitting}}</text>
          </button>
        </view>
        
        <!-- æ„Ÿè°¢ä¿¡æ¯ -->
        <view class="thank-you-container" wx:if="{{feedbackSubmitted}}">
          <view class="thank-you-icon">ğŸ™</view>
          <text class="thank-you-title">{{i18n.result.thankYouTitle}}</text>
          <text class="thank-you-text">{{i18n.result.thankYouText}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æ— æ•°æ®çŠ¶æ€ -->
  <view class="empty-state" wx:elif="{{!loading && !result}}">
    <view class="empty-content">
      <text class="empty-icon">ğŸŒ™</text>
      <text class="empty-text">{{i18n.result.noResult}}</text>
    </view>
  </view>

  <!-- posterç»„ä»¶ç”¨äºæµ·æŠ¥ç”Ÿæˆ -->
  <poster 
    id="poster" 
    config="{{posterConfig}}"
    bind:success="onPosterSuccess" 
    bind:fail="onPosterFail"
    style="position: fixed; top: -9999rpx; left: -9999rpx; width: 0rpx; height: 0rpx; opacity: 0;"
  >
  </poster>
  
  <!-- éšè—çš„canvasç”¨äºè§†é¢‘å°é¢ç”Ÿæˆ -->
  <canvas 
    id="video-canvas" 
    type="2d" 
    style="position: fixed; top: -9999rpx; left: -9999rpx; width: 0rpx; height: 0rpx; opacity: 0;"
  ></canvas>
  
  <!-- ä¸ªäººä¿¡æ¯è®¾ç½®å¼¹çª— -->
  <profile-setup-modal 
    show="{{showProfileSetupModal}}"
    bind:setupComplete="onProfileSetupComplete"
    bind:close="onCloseProfileSetupModal"
  />
</view>

