<!--ç»“æœé¡µ-->
<view class="container">

  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <!-- <view class="header">
    <view class="nav-icon" bindtap="onBackHome">
      <text class="icon-arrow">â†</text>
    </view>
    <text class="header-title">è§£æç»“æœ</text>
    <view class="nav-icon" bindtap="onClose">
      <text class="icon-close">Ã—</text>
    </view>
  </view> -->

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-state" wx:if="{{loading}}">
    <view class="loading-content">
      <view class="loading-spinner"></view>
      <text class="loading-text">{{i18n.result.loading}}</text>
    </view>
  </view>

  <!-- ç»“æœå†…å®¹ -->
  <view class="result-content" wx:elif="{{result}}">
    <!-- æ¢¦å¢ƒå†…å®¹ -->
    <view class="dream-content-section">
      <view class="section-title">{{i18n.result.dreamContent}}</view>
      <view class="cloud-card dream-content-card">
        <text class="dream-text" user-select="{{true}}">{{result.dreamDescription}}</text>
      </view>
    </view>

    <!-- å…³é”®è¯ -->
    <view class="keywords-section" wx:if="{{result.keywords && result.keywords.length > 0}}">
      <view class="section-title">{{i18n.result.keywords}}</view>
      <view class="keywords-container">
        <view class="keyword-tag" wx:for="{{result.keywords}}" wx:key="index">
          {{item}}
        </view>
      </view>
    </view>

    <!-- æ¢¦å¢ƒè§£æ -->
    <view class="analysis-section" wx:if="{{result.interpretation}}">
      <view class="section-title">{{i18n.result.dreamAnalysis}}</view>
      <view class="cloud-card analysis-card">
        <view class="analysis-content">
          <!-- ä¸“ä¸šç‰ˆï¼šä½¿ç”¨ rich-text æ¸²æŸ“ markdown -->
          <rich-text 
            wx:if="{{result.generationType === 'professional' && result.interpretationHTML}}" 
            nodes="{{result.interpretationHTML}}" 
            class="markdown-content"
            user-select="{{true}}"
          ></rich-text>
          <!-- æ™®é€šç‰ˆï¼šä½¿ç”¨æ®µè½æ˜¾ç¤º -->
          <view wx:else>
            <view class="analysis-paragraph" wx:for="{{result.interpretationParagraphs}}" wx:key="index" user-select="{{true}}">
              {{item}}
            </view>
          </view>
        </view>
        <view class="ai-disclaimer">
          <text class="disclaimer-text">{{i18n.result.aiDisclaimer}}</text>
        </view>
      </view>
    </view>

    <!-- å‘¨å…¬è§£æ¢¦ -->
    <view class="zhougong-section">
      <view class="section-title">å‘¨å…¬è§£æ¢¦</view>
      <view class="cloud-card zhougong-card" bindtap="{{!zhougong.loaded ? 'onFetchZhougong' : ''}}">
        <!-- æœªåŠ è½½çŠ¶æ€ï¼šæ¨¡ç³Šé®ç½© -->
        <view class="zhougong-blur-wrapper" wx:if="{{!zhougong.loaded}}">
           <!-- æ¨¡ç³ŠèƒŒæ™¯å±‚ï¼ˆè§†è§‰å ä½ï¼‰ -->
           <view class="zhougong-blur-bg">
             <view class="blur-line" style="width: 90%"></view>
             <view class="blur-line" style="width: 85%"></view>
             <view class="blur-line" style="width: 95%"></view>
             <view class="blur-line" style="width: 60%"></view>
           </view>
           
           <!-- æ“ä½œå±‚ -->
           <view class="zhougong-action-layer">
             <block wx:if="{{zhougong.loading}}">
                <van-loading type="spinner" size="32px" color="#8B5CF6" vertical>
                  <text style="color: #8B5CF6; font-size: 24rpx; margin-top: 10rpx;">æ­£åœ¨æŸ¥é˜…å¤ç±...</text>
                </van-loading>
             </block>
             <block wx:else>
                <text class="unlock-text">ç‚¹å‡»æŸ¥çœ‹å‘¨å…¬è§£æ¢¦</text>
                <text class="unlock-tip">æ¢ç´¢ä¼ ç»Ÿæ–‡åŒ–å¯¹æ¢¦å¢ƒçš„è§£è¯»</text>
                <view class="points-tip">
                  <text class="points-icon">âœ¨</text>
                  <text class="points-text">æ¶ˆè€— 20 ç§¯åˆ†æŸ¥çœ‹</text>
                </view>
             </block>
           </view>
        </view>
        
        <!-- å·²åŠ è½½çŠ¶æ€ï¼šå†…å®¹ -->
        <view class="zhougong-content" wx:else>
           <text class="zhougong-text" user-select="{{true}}">{{zhougong.result}}</text>
        </view>
      </view>
    </view>

    <!-- ç–å¯¼æ€§é—®é¢˜ -->
    <view class="guiding-questions-section" wx:if="{{result.guidingQuestion1 || result.guidingQuestion2}}">
      <view class="section-title">{{i18n.result.guidingQuestions}}</view>
      <view class="cloud-card guiding-questions-card">
        <view class="questions-intro">
          <text class="intro-text">{{i18n.result.questionsIntro}}</text>
        </view>

        <!-- å¼•å¯¼é—®é¢˜æŠ˜å é¢æ¿ -->
        <van-collapse value="{{activeNames}}" bind:change="onCollapseChange" wx:if="{{result.guidingQuestion1 || result.guidingQuestion2}}">
          <!-- é—®é¢˜ä¸€ -->
          <van-collapse-item name="question1" title="{{i18n.result.question1}}" wx:if="{{result.guidingQuestion1}}" custom-class="question-collapse-item">
            <view class="question-content">
              <text class="question-text" user-select="{{true}}">{{result.guidingQuestion1}}</text>
            </view>
            <view class="answer-container" wx:if="{{!result.guidingQuestion1Answer}}">
              <textarea class="answer-textarea" placeholder="{{i18n.result.answerPlaceholder}}" value="{{answer1}}" bindinput="onAnswer1Input" maxlength="500" show-confirm-bar="{{false}}"></textarea>
              <view class="char-count">{{answer1.length}}/500</view>
            </view>
          </van-collapse-item>

          <!-- é—®é¢˜äºŒ -->
          <van-collapse-item name="question2" title="{{i18n.result.question2}}" wx:if="{{result.guidingQuestion2}}" custom-class="question-collapse-item">
            <view class="question-content">
              <text class="question-text" user-select="{{true}}">{{result.guidingQuestion2}}</text>
            </view>
            <view class="answer-container" wx:if="{{!result.guidingQuestion2Answer}}">
              <textarea class="answer-textarea" placeholder="{{i18n.result.answerPlaceholder}}" value="{{answer2}}" bindinput="onAnswer2Input" maxlength="500" show-confirm-bar="{{false}}"></textarea>
              <view class="char-count">{{answer2.length}}/500</view>
            </view>
          </van-collapse-item>
        </van-collapse>

        <!-- ä¿å­˜å›ç­”æŒ‰é’® -->
        <view class="save-answers-container" wx:if="{{(!result.guidingQuestion1Answer && answer1) || (!result.guidingQuestion2Answer && answer2)}}">
          <button class="save-answers-btn {{savingAnswers ? 'saving' : ''}}" bindtap="onSaveAnswers" disabled="{{savingAnswers}}">
            <text wx:if="{{!savingAnswers}}">{{i18n.result.saveAnswers}}</text>
            <text wx:else>{{i18n.result.saving}}</text>
          </button>
        </view>
      </view>
    </view>

    <!-- AIæ¢¦å¢ƒå›¾åƒï¼ˆä»…æ–‡ç”Ÿå›¾æ¨¡å¼ï¼‰ -->
    <view class="image-section" wx:if="{{!isVideoType && (result.imageUrl || imageLoading)}}">
      <view class="section-title">{{i18n.result.aiImage}}</view>
      
      <!-- å›¾ç‰‡ç”Ÿæˆä¸­çŠ¶æ€ -->
      <view class="image-status-container" wx:if="{{imageLoading && !result.imageUrl}}">
        <view class="cloud-card image-status-card">
          <view class="status-icon">
            <van-loading type="spinner" size="32px" color="#8B5CF6" />
          </view>
          <view class="status-text">{{i18n.result.imageGenerating}}</view>
          <view class="status-tip">{{i18n.result.imageGeneratingTip}}</view>
        </view>
      </view>

      <!-- å›¾ç‰‡æ˜¾ç¤º -->
      <view class="image-container" wx:elif="{{result.imageUrl}}">
        <image class="dream-image" src="{{result.imageUrl}}" mode="aspectFill" bindtap="onPreviewImage" />
      </view>
      
      <view class="image-description" wx:if="{{result.imagePrompt}}">
        <text class="description-text" user-select="{{true}}">{{result.imagePrompt}}</text>
      </view>
    </view>

    <!-- AIæ¢¦å¢ƒè§†é¢‘ï¼ˆä»…æ–‡ç”Ÿè§†é¢‘æ¨¡å¼ï¼‰ -->
    <view class="video-section" wx:if="{{isVideoType}}">
      <view class="section-title">{{i18n.result.aiDreamVideo}}</view>

      <!-- è§†é¢‘ç”Ÿæˆä¸­çŠ¶æ€ -->
      <view class="video-status-container" wx:if="{{videoStatus === 'processing' || videoStatus === 'pending'}}">
        <view class="cloud-card video-status-card">
          <view class="status-icon">
            <van-loading type="spinner" size="32px" color="#8B5CF6" />
          </view>
          <view class="status-text">{{i18n.result.videoGenerating}}</view>
          <view class="status-tip">{{i18n.result.videoGeneratingTip}}</view>
        </view>
        <!-- è§†é¢‘æç¤ºè¯æè¿° -->
        <view class="video-description" wx:if="{{result.videoPrompt}}">
          <text class="description-text" user-select="{{true}}">{{result.videoPrompt}}</text>
        </view>
      </view>

      <!-- è§†é¢‘ç”Ÿæˆå¤±è´¥çŠ¶æ€ -->
      <view class="video-status-container" wx:if="{{videoStatus === 'failed'}}">
        <view class="cloud-card video-status-card">
          <view class="status-icon">âŒ</view>
          <view class="status-text">{{i18n.result.videoFailed}}</view>
          <view class="status-tip">{{i18n.result.videoFailedTip}}</view>
        </view>
        <!-- è§†é¢‘æç¤ºè¯æè¿° -->
        <view class="video-description" wx:if="{{result.videoPrompt}}">
          <text class="description-text" user-select="{{true}}">{{result.videoPrompt}}</text>
        </view>
      </view>

      <!-- è§†é¢‘æ’­æ”¾å™¨ -->
      <view class="video-container" wx:if="{{videoStatus === 'completed' && videoUrl}}">
        <video class="dream-video" src="{{videoUrl}}" controls show-center-play-btn enable-play-gesture object-fit="contain"></video>

        <!-- è§†é¢‘æ“ä½œæŒ‰é’® -->
        <view class="video-actions">
          <button class="video-action-btn download-btn" bindtap="onDownloadVideo">
            <text class="action-icon">â¬‡ï¸</text>
            <text class="action-text">{{i18n.result.downloadVideo}}</text>
          </button>
        </view>

        <!-- è§†é¢‘æç¤ºè¯æè¿° -->
        <view class="video-description" wx:if="{{result.videoPrompt}}">
          <text class="description-text" user-select="{{true}}">{{result.videoPrompt}}</text>
        </view>
      </view>
    </view>

    <!-- å‘å¸ƒ/æµ·æŠ¥ æŒ‰é’®æ¨ªæ’ï¼ˆä¸“ä¸šç‰ˆä¸æ˜¾ç¤ºï¼‰ -->
    <view class="actions-section" wx:if="{{result && result.generationType !== 'professional'}}">
      <button class="action-btn publish-button small" wx:if="{{result.analysisId && isLoggedIn}}" bindtap="onTogglePublishOrPrivate">
        <text class="publish-icon">ğŸ“¤</text>
        <text class="publish-text">{{result.visibility === 1 ? i18n.result.setToPrivate : i18n.result.publish}}</text>
      </button>
      <button class="action-btn poster-button small" bindtap="onGeneratePoster" wx:if="{{(!isVideoType && !imageLoading && result.imageUrl) || (isVideoType && videoStatus === 'completed' && videoUrl)}}">
        <text class="poster-icon">ğŸ¨</text>
        <text class="poster-text">{{i18n.result.generatePoster}}</text>
      </button>
    </view>

    <!-- åé¦ˆåŒºåŸŸ -->
    <view class="feedback-section" wx:if="{{result}}">
      <view class="section-title">{{i18n.result.rateUs}}</view>
      <view class="cloud-card feedback-card">
        <!-- åé¦ˆè¡¨å• -->
        <view wx:if="{{!result.hasFeedback}}">
          <!-- æ˜Ÿçº§è¯„åˆ† -->
          <view class="rating-container">
            <text class="rating-label">{{i18n.result.ratingLabel}}</text>
            <view class="stars-container">
              <view class="star {{index < feedbackRating ? 'active' : ''}}" wx:for="{{[1,2,3,4,5]}}" wx:key="index" data-rating="{{index + 1}}" bindtap="onStarTap">
                {{index < feedbackRating ? 'â­' : 'â˜†'}}
              </view>
            </view>
            <text class="rating-text">{{feedbackRating > 0 ? feedbackRating + i18n.result.score : i18n.result.selectRating}}</text>
          </view>

          <!-- åé¦ˆè¾“å…¥æ¡† -->
          <view class="feedback-input-container">
            <text class="feedback-label">{{i18n.result.feedbackLabel}}</text>
            <textarea class="feedback-textarea" placeholder="{{i18n.result.feedbackPlaceholder}}" value="{{feedbackContent}}" bindinput="onFeedbackInput" maxlength="1000" show-confirm-bar="{{false}}"></textarea>
            <view class="char-count">{{feedbackContent.length}}/1000</view>
          </view>

          <!-- æäº¤æŒ‰é’® -->
          <button class="feedback-submit-btn {{submittingFeedback ? 'submitting' : ''}}" bindtap="onSubmitFeedback" disabled="{{submittingFeedback}}">
            <text wx:if="{{!submittingFeedback}}">{{i18n.result.submitFeedback}}</text>
            <text wx:else>{{i18n.result.submitting}}</text>
          </button>
        </view>

        <!-- æ„Ÿè°¢ä¿¡æ¯ -->
        <view class="thank-you-container" wx:if="{{result.hasFeedback}}">
          <view class="thank-you-icon">ğŸ™</view>
          <text class="thank-you-title">{{i18n.result.thankYouTitle}}</text>
          <text class="thank-you-text">{{i18n.result.thankYouText}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æ— æ•°æ®çŠ¶æ€ -->
  <view class="empty-state" wx:elif="{{!loading && !result}}">
    <view class="empty-content">
      <text class="empty-icon">ğŸŒ™</text>
      <text class="empty-text">{{i18n.result.noResult}}</text>
    </view>
  </view>

  

  <!-- Painterç»„ä»¶ç”¨äºæµ·æŠ¥ç”Ÿæˆ -->
  <painter customStyle="position: absolute; left: -9999rpx; top: -9999rpx;" palette="{{painterPalette}}" bind:imgOK="onPainterImgOK" bind:imgErr="onPainterImgErr" widthPixels="1000" />

  <!-- éšè—çš„canvasç”¨äºè§†é¢‘å°é¢ç”Ÿæˆ -->
  <canvas id="video-canvas" type="2d" style="position: fixed; top: -9999rpx; left: -9999rpx; width: 0rpx; height: 0rpx; opacity: 0;"></canvas>

  <!-- ä¸ªäººä¿¡æ¯è®¾ç½®å¼¹çª— -->
  <profile-setup-modal show="{{showProfileSetupModal}}" bind:setupComplete="onProfileSetupComplete" bind:close="onCloseProfileSetupModal" bind:skip="onProfileSetupSkip" />
</view>