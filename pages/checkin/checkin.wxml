<!--积分任务签到页面-->
<view class="checkin-container">
  <!-- 积分规则提示 -->
  <view class="rules-hint" bindtap="showRules">
    <text class="question-icon">?</text>
    <text class="rules-text">{{i18n.checkin.rulesTitle}}</text>
  </view>

  <!-- 签到区域 -->
  <view class="checkin-section">
    <view class="checkin-circle">
      <view class="circle-bg"></view>
      <view class="circle-content">
        <text class="checkin-label">{{i18n.checkin.consecutiveDays}}</text>
        <view class="checkin-days">
          <text class="days-number">{{monthSigninDays}}</text>
          <text class="days-unit">{{i18n.checkin.day}}</text>
        </view>
      </view>
    </view>
    <button class="checkin-btn {{isCheckedIn ? 'checked-in' : ''}}" bindtap="handleCheckin" disabled="{{isCheckedIn || isChecking}}">
      {{isChecking ? i18n.checkin.checking : (isCheckedIn ? i18n.checkin.checkedIn : i18n.checkin.checkinNow)}}
    </button>
    <view class="tomorrow-reward">
      <text class="reward-icon">✨</text>
      <text class="reward-text">{{i18n.checkin.tomorrowReward}} +{{tomorrowReward}} {{language === 'zh' ? '积分' : ' points'}}</text>
    </view>
  </view>

  <!-- 积分摘要 -->
  <view class="points-summary">
    <view class="points-item">
      <view class="points-icon today">
        <van-icon name="arrow-up" size="40rpx" color="#ffffff" />
      </view>
      <text class="points-label">{{i18n.checkin.todayPoints}}</text>
      <text class="points-value">{{todayPoints}}</text>
    </view>
    <view class="points-item">
      <view class="points-icon total">
        <van-icon name="star-o" size="40rpx" color="#ffffff" />
      </view>
      <text class="points-label">{{i18n.checkin.myPoints}}</text>
      <text class="points-value">{{totalPoints}}</text>
    </view>
  </view>

  <!-- 刮刮乐弹窗 -->
  <van-popup 
    show="{{ showScratchPopup }}" 
    round
    closeable
    close-icon="close"
    bind:close="closeScratchPopup"
    custom-style="padding: 40rpx 30rpx 30rpx;"
  >
    <view class="scratch-popup">
      <view class="scratch-popup-title">{{i18n.checkin.scratchTitle || '刮刮乐'}}</view>
      <view class="scratch-popup-subtitle">{{i18n.checkin.scratchSubtitle || '刮开涂层，领取积分奖励'}}</view>
      
      <view class="scratch-card-wrapper">
        <view class="scratch-card">
          <!-- 背景层：显示积分信息 -->
          <view class="scratch-bg">
            <!-- 始终显示积分信息 -->
            <view class="scratch-result">
              <text class="result-label">{{i18n.checkin.scratchResultLabel || '恭喜获得'}}</text>
              <view class="result-points">
                <text class="points-number">+{{scratchPoints}}</text>
                <text class="points-text">{{language === 'zh' ? '积分' : ' points'}}</text>
              </view>
            </view>
          </view>
          <!-- 临时遮罩层：Canvas 未加载时显示 -->
          <view class="scratch-temp-mask" wx:if="{{!canvasReady}}">
            <text class="temp-mask-text">刮开涂层</text>
          </view>
          <!-- Canvas 覆盖层：可刮涂层 -->
          <canvas 
            class="scratch-canvas" 
            type="2d"
            id="scratchCanvas"
            disable-scroll="true"
            bindtouchstart="onScratchStart"
            bindtouchmove="onScratchMove"
            bindtouchend="onScratchEnd"
          ></canvas>
        </view>
      </view>
    </view>
  </van-popup>

  <!-- 任务列表 -->
  <view class="tasks-section">
    <view class="tasks-title">{{i18n.checkin.tasksTitle}}</view>
    <view class="task-list">
      <view class="task-card" wx:for="{{taskList}}" wx:key="id">
        <view class="task-icon-wrapper">
          <view class="task-icon {{item.iconClass}}">
            <van-icon name="{{item.iconName}}" size="48rpx" color="#8B5CF6" />
          </view>
        </view>
        <view class="task-content">
          <view class="task-title">{{item.title}}</view>
          <view class="task-desc">{{item.desc}}</view>
          <view class="task-points">{{item.points}}</view>
        </view>
        <button wx:if="{{item.type === 'share' && !item.completed}}" class="task-btn" open-type="share">
          {{item.buttonText}}
        </button>
        <button wx:elif="{{item.type === 'share' && item.completed}}" class="task-btn completed" disabled>
          {{i18n.checkin.completed}}
        </button>
        <button wx:else class="task-btn {{item.completed ? 'completed' : ''}}" bindtap="handleTask" data-id="{{item.id}}" disabled="{{item.completed}}">
          {{item.completed ? i18n.checkin.completed : item.buttonText}}
        </button>
      </view>
    </view>
  </view>
</view>

