<!--Ê¢¶Â¢ÉÊó•ËÆ∞È°µ-->
<view class="container language-{{language}}">
  <!-- ËÉåÊôØÂõæÁâá -->
  <image class="background-image" src="https://dulele.org.cn/images/assest/index_v2_bg_16.jpg" mode="aspectFill"></image>


  <!-- Âä†ËΩΩÁä∂ÊÄÅ -->
  <view class="loading-state" wx:if="{{loading}}">
    <view class="loading-content">
      <view class="loading-spinner"></view>
      <text class="loading-text">{{i18n.diary.loading}}</text>
    </view>
  </view>

  <!-- ÁªìÊûúÂÜÖÂÆπ -->
  <view class="result-content" wx:elif="{{result}}">
    <!-- Ê¢¶Â¢ÉÂÜÖÂÆπ -->
    <view class="dream-content-section">
      <view class="section-title">{{i18n.diary.dreamContent}}</view>
      <view class="cloud-card dream-content-card">
        <text class="dream-text" user-select="{{true}}">{{result.dreamDescription}}</text>
      </view>
    </view>

    <!-- ÂÖ≥ÈîÆËØç -->
    <view class="keywords-section" wx:if="{{result.keywords && result.keywords.length > 0}}">
      <view class="section-title">{{i18n.diary.keywords}}</view>
      <view class="keywords-container">
        <view class="keyword-tag" wx:for="{{result.keywords}}" wx:key="index">
          {{item}}
        </view>
      </view>
    </view>

    <!-- Ê¢¶Â¢ÉËß£Êûê -->
    <view class="analysis-section" wx:if="{{result.interpretation}}">
      <view class="section-title">{{i18n.diary.dreamAnalysis}}</view>
      <view class="cloud-card analysis-card">
        <view class="analysis-content">
          <!-- ‰∏ì‰∏öÁâàÔºö‰ΩøÁî® rich-text Ê∏≤Êüì markdown -->
          <rich-text 
            wx:if="{{result.generationType === 'professional' && result.interpretationHTML}}" 
            nodes="{{result.interpretationHTML}}" 
            class="markdown-content"
            user-select="{{true}}"
          ></rich-text>
          <!-- ÊôÆÈÄöÁâàÔºö‰ΩøÁî®ÊÆµËêΩÊòæÁ§∫ -->
          <view wx:else>
            <view class="analysis-paragraph" wx:for="{{result.interpretationParagraphs}}" wx:key="index" user-select="{{true}}">
              {{item}}
            </view>
          </view>
        </view>
        <view class="ai-disclaimer">
          <text class="disclaimer-text">{{i18n.diary.aiDisclaimer}}</text>
        </view>
      </view>
    </view>

    <!-- ÁñèÂØºÊÄßÈóÆÈ¢ò -->
    <view class="guiding-questions-section" wx:if="{{result.guidingQuestion1 || result.guidingQuestion2}}">
      <view class="section-title">{{i18n.diary.guidingQuestions}}</view>
      <view class="cloud-card guiding-questions-card">
        <view class="questions-intro">
          <text class="intro-text">{{i18n.diary.questionsIntro}}</text>
        </view>

        <!-- ÂºïÂØºÈóÆÈ¢òÊäòÂè†Èù¢Êùø -->
        <van-collapse value="{{activeNames}}" bind:change="onCollapseChange" wx:if="{{result.guidingQuestion1 || result.guidingQuestion2}}">
          <!-- ÈóÆÈ¢ò‰∏Ä -->
          <van-collapse-item name="question1" title="{{i18n.diary.question1}}" wx:if="{{result.guidingQuestion1}}" custom-class="question-collapse-item">
            <view class="question-content">
              <text class="question-text" user-select="{{true}}">{{result.guidingQuestion1}}</text>
            </view>
            <view class="answer-container" wx:if="{{!result.guidingQuestion1Answer}}">
              <textarea class="answer-textarea" placeholder="{{i18n.diary.answerPlaceholder}}" value="{{answer1}}" bindinput="onAnswer1Input" maxlength="500" show-confirm-bar="{{false}}"></textarea>
              <view class="char-count">{{answer1.length}}/500</view>
            </view>
          </van-collapse-item>

          <!-- ÈóÆÈ¢ò‰∫å -->
          <van-collapse-item name="question2" title="{{i18n.diary.question2}}" wx:if="{{result.guidingQuestion2}}" custom-class="question-collapse-item">
            <view class="question-content">
              <text class="question-text" user-select="{{true}}">{{result.guidingQuestion2}}</text>
            </view>
            <view class="answer-container" wx:if="{{!result.guidingQuestion2Answer}}">
              <textarea class="answer-textarea" placeholder="{{i18n.diary.answerPlaceholder}}" value="{{answer2}}" bindinput="onAnswer2Input" maxlength="500" show-confirm-bar="{{false}}"></textarea>
              <view class="char-count">{{answer2.length}}/500</view>
            </view>
          </van-collapse-item>
        </van-collapse>

        <!-- ‰øùÂ≠òÂõûÁ≠îÊåâÈíÆ -->
        <view class="save-answers-container" wx:if="{{(!result.guidingQuestion1Answer && answer1) || (!result.guidingQuestion2Answer && answer2)}}">
          <button class="save-answers-btn {{savingAnswers ? 'saving' : ''}}" bindtap="onSaveAnswers" disabled="{{savingAnswers}}">
            <text wx:if="{{!savingAnswers}}">{{i18n.diary.saveAnswers}}</text>
            <text wx:else>{{i18n.diary.saving}}</text>
          </button>
        </view>
      </view>
    </view>

    <!-- AIÊ¢¶Â¢ÉÂõæÂÉèÔºà‰ªÖÊñáÁîüÂõæÊ®°ÂºèÔºâ -->
    <view class="image-section" wx:if="{{!isVideoType && (result.imageUrl || imageLoading)}}">
      <view class="section-title">{{i18n.diary.aiImage}}</view>

      <!-- ÂõæÁâáÁîüÊàê‰∏≠Áä∂ÊÄÅ -->
      <view class="image-status-container" wx:if="{{imageLoading && !result.imageUrl}}">
        <view class="cloud-card video-status-card">
          <view class="status-icon">‚è≥</view>
          <view class="status-text">{{i18n.diary.imageGenerating}}</view>
          <view class="status-tip">{{i18n.diary.imageGeneratingTip}}</view>
        </view>
      </view>

      <!-- ÂõæÁâáÊòæÁ§∫ -->
      <view class="image-container" wx:elif="{{result.imageUrl}}">
        <image class="dream-image" src="{{result.imageUrl}}" mode="aspectFill" bindtap="onPreviewImage" />
      </view>

      <view class="image-description" wx:if="{{result.imagePrompt}}">
        <text class="description-text" user-select="{{true}}">{{result.imagePrompt}}</text>
      </view>
    </view>

    <!-- AIÊ¢¶Â¢ÉËßÜÈ¢ëÔºà‰ªÖÊñáÁîüËßÜÈ¢ëÊ®°ÂºèÔºâ -->
    <view class="video-section" wx:if="{{isVideoType}}">
      <view class="section-title">{{i18n.diary.aiVideo}}</view>

      <!-- ËßÜÈ¢ëÁîüÊàê‰∏≠Áä∂ÊÄÅ -->
      <view class="video-status-container" wx:if="{{videoStatus === 1}}">
        <view class="cloud-card video-status-card">
          <view class="status-icon">‚è≥</view>
          <view class="status-text">{{i18n.diary.videoGenerating}}</view>
          <view class="status-tip">{{i18n.diary.videoGeneratingTip}}</view>
        </view>
      </view>

      <!-- ËßÜÈ¢ëÁîüÊàêÂ§±Ë¥•Áä∂ÊÄÅ -->
      <view class="video-status-container" wx:if="{{videoStatus === 3}}">
        <view class="cloud-card video-status-card">
          <view class="status-icon">‚ùå</view>
          <view class="status-text">{{i18n.diary.videoFailed}}</view>
          <view class="status-tip">{{i18n.diary.videoFailedTip}}</view>
        </view>
      </view>

      <!-- ËßÜÈ¢ëÂç°ÁâáÔºàÁ±ª‰ººÂõæÁâáÂç°ÁâáÊ†∑ÂºèÔºâ -->
      <view class="video-card-container" wx:if="{{videoStatus === 2 && videoUrl}}">
        <view class="cloud-card video-card">
          <!-- ËßÜÈ¢ëÊí≠ÊîæÂô® -->
          <view class="video-container">
            <video class="dream-video" src="{{videoUrl}}" controls show-center-play-btn enable-play-gesture object-fit="contain"></video>
          </view>

          <!-- ËßÜÈ¢ëÊìç‰ΩúÊåâÈíÆ -->
          <view class="video-actions">
            <button class="video-action-btn download-btn" bindtap="onDownloadVideo">
              <text class="action-icon">‚¨áÔ∏è</text>
              <text class="action-text">{{i18n.diary.downloadVideo}}</text>
            </button>
          </view>

          <!-- ËßÜÈ¢ëÊèêÁ§∫ËØçÊèèËø∞ -->
          <view class="video-description" wx:if="{{result.videoPrompt}}">
            <text class="description-text" user-select="{{true}}">{{result.videoPrompt}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- ÂèëÂ∏É/Êµ∑Êä• ÊåâÈíÆÊ®™Êéí -->
    <view class="actions-section" wx:if="{{result}}">
      <!-- Â∑≤ÂèëÂ∏ÉÂà∞Á§æÂå∫ÔºåÊòæÁ§∫ËÆæÁΩÆ‰∏∫‰ªÖ‰∏™‰∫∫ÂèØËßÅÊåâÈíÆÔºà‰∏ì‰∏öÁâà‰∏çÊòæÁ§∫Ôºâ -->
      <button class="action-btn private-button small" wx:if="{{result.generationType !== 'professional' && result.analysisId && isLoggedIn && result.visibility === 1}}" bindtap="onSetToPrivate">
        <text class="private-icon">üîí</text>
        <text class="private-text">{{i18n.diary.setToPrivate}}</text>
      </button>

      <!-- Êú™ÂèëÂ∏ÉÂà∞Á§æÂå∫ÔºåÊòæÁ§∫ÂèëÂ∏ÉÊåâÈíÆÔºà‰∏ì‰∏öÁâà‰∏çÊòæÁ§∫Ôºâ -->
      <button class="action-btn publish-button small" wx:elif="{{result.generationType !== 'professional' && result.analysisId && isLoggedIn}}" bindtap="onPublishToCommunity">
        <text class="publish-icon">üì§</text>
        <text class="publish-text">{{i18n.diary.publish}}</text>
      </button>

      <!-- ÁîüÊàêÊµ∑Êä•ÊåâÈíÆÔºöÂè™Âú®ËßÜÈ¢ëÊàñÂõæÁâáÁîüÊàêÂÆåÊàêÂêéÊòæÁ§∫Ôºå‰∏ì‰∏öÁâà‰∏çÊòæÁ§∫ -->
      <!-- Êù°‰ª∂Ôºö1.ËßÜÈ¢ëÊ®°ÂºèÔºöÂ∑≤ÂÆåÊàê(videoStatus=2)‰∏îÊúâËßÜÈ¢ëURL 2.ÂõæÁâáÊ®°ÂºèÔºöÊúâÂõæÁâáURL‰∏î‰∏çÂú®Âä†ËΩΩ‰∏≠ 3.Á∫ØÊñáÊú¨Ê®°ÂºèÔºöÊ≤°ÊúâÂõæÁâáÂíåËßÜÈ¢ëÊèêÁ§∫ËØç 4.ÊéíÈô§‰∏ì‰∏öÁâà -->
      <button class="action-btn poster-button small" wx:if="{{result.generationType !== 'professional' && ((isVideoType && videoStatus === 2 && videoUrl) || (!isVideoType && result.imageUrl && !imageLoading) || (!result.imagePrompt && !result.videoPrompt))}}" bindtap="onGeneratePoster">
        <text class="poster-icon">üé®</text>
        <text class="poster-text">{{i18n.diary.generatePoster}}</text>
      </button>
    </view>

    <!-- ÂèçÈ¶àÂå∫Âüü -->
    <view class="feedback-section" wx:if="{{result}}">
      <view class="section-title">{{i18n.diary.rateUs}}</view>
      <view class="cloud-card feedback-card">
        <!-- ÂèçÈ¶àË°®Âçï -->
        <view wx:if="{{!result.hasFeedback}}">
          <!-- ÊòüÁ∫ßËØÑÂàÜ -->
          <view class="rating-container">
            <text class="rating-label">{{i18n.diary.ratingLabel}}</text>
            <view class="stars-container">
              <view class="star {{index < feedbackRating ? 'active' : ''}}" wx:for="{{[1,2,3,4,5]}}" wx:key="index" data-rating="{{index + 1}}" bindtap="onStarTap">
                {{index < feedbackRating ? '‚≠ê' : '‚òÜ'}}
              </view>
            </view>
            <text class="rating-text">{{feedbackRating > 0 ? feedbackRating + i18n.diary.score : i18n.diary.selectRating}}</text>
          </view>

          <!-- ÂèçÈ¶àËæìÂÖ•Ê°Ü -->
          <view class="feedback-input-container">
            <text class="feedback-label">{{i18n.diary.feedbackLabel}}</text>
            <textarea class="feedback-textarea" placeholder="{{i18n.diary.feedbackPlaceholder}}" value="{{feedbackContent}}" bindinput="onFeedbackInput" maxlength="1000" show-confirm-bar="{{false}}"></textarea>
            <view class="char-count">{{feedbackContent.length}}/1000</view>
          </view>

          <!-- Êèê‰∫§ÊåâÈíÆ -->
          <button class="feedback-submit-btn {{submittingFeedback ? 'submitting' : ''}}" bindtap="onSubmitFeedback" disabled="{{submittingFeedback}}">
            <text wx:if="{{!submittingFeedback}}">{{i18n.diary.submitFeedback}}</text>
            <text wx:else>{{i18n.diary.submitting}}</text>
          </button>
        </view>

        <!-- ÊÑüË∞¢‰ø°ÊÅØ -->
        <view class="thank-you-container" wx:if="{{result.hasFeedback}}">
          <view class="thank-you-icon">üôè</view>
          <text class="thank-you-title">{{i18n.diary.thankYouTitle}}</text>
          <text class="thank-you-text">{{i18n.diary.thankYouText}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- Êó†Êï∞ÊçÆÁä∂ÊÄÅ -->
  <view class="empty-state" wx:elif="{{!loading && !result}}">
    <view class="empty-content">
      <text class="empty-icon">üåô</text>
      <text class="empty-text">{{i18n.diary.noResult}}</text>
    </view>
  </view>

  <!-- PainterÁªÑ‰ª∂Áî®‰∫éÊµ∑Êä•ÁîüÊàê -->
  <painter customStyle="position: absolute; left: -9999rpx; top: -9999rpx;" palette="{{painterPalette}}" bind:imgOK="onPainterImgOK" bind:imgErr="onPainterImgErr" widthPixels="1000" />

  <!-- ÈöêËóèÁöÑcanvasÁî®‰∫éËßÜÈ¢ëÂ∞ÅÈù¢ÁîüÊàê -->
  <canvas id="video-canvas" type="2d" style="position: fixed; top: -9999rpx; left: -9999rpx; width: 0rpx; height: 0rpx; opacity: 0;"></canvas>

  <!-- ‰∏™‰∫∫‰ø°ÊÅØËÆæÁΩÆÂºπÁ™ó -->
  <profile-setup-modal show="{{showProfileSetupModal}}" bind:setupComplete="onProfileSetupComplete" bind:close="onCloseProfileSetupModal" bind:skip="onProfileSetupSkip" />
</view>